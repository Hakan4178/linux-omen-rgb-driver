# OMEN RGB Driver - Basit Makefile
# Sadece Ã§alÄ±ÅŸsÄ±n yeter!

KERNEL_VERSION := $(shell uname -r)
KERNEL_DIR := /lib/modules/$(KERNEL_VERSION)/build
PWD := $(shell pwd)

# Module tanÄ±mÄ±
obj-m += omen_kernel_mainline_final.o

# Basit CFLAGS
ccflags-y += -Wall -O2

# Ana hedef
all:
	@echo "ğŸ”¨ OMEN RGB driver build ediliyor..."
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules
	@if [ -f "omen_kernel_mainline_final.ko" ]; then \
		echo "âœ… Build baÅŸarÄ±lÄ±!"; \
		ls -la omen_kernel_mainline_final.ko; \
	else \
		echo "âŒ Build baÅŸarÄ±sÄ±z!"; \
	fi

# Test - sadece build kontrolÃ¼
test: all
	@echo "ğŸ§ª Basit test..."
	@if [ -f "omen_kernel_mainline_final.ko" ]; then \
		echo "âœ… Module dosyasÄ± var"; \
		modinfo omen_kernel_mainline_final.ko | head -5; \
	else \
		echo "âŒ Module dosyasÄ± yok"; \
	fi

# Kurulum
install: all
	@echo "ğŸ“¦ Kurulum..."
	@if [ $$(id -u) -ne 0 ]; then \
		echo "âŒ Root gerekli: sudo make install"; \
		exit 1; \
	fi
	cp omen_kernel_mainline_final.ko /lib/modules/$(KERNEL_VERSION)/extra/ || mkdir -p /lib/modules/$(KERNEL_VERSION)/extra/ && cp omen_kernel_mainline_final.ko /lib/modules/$(KERNEL_VERSION)/extra/
	depmod -a
	@echo "âœ… Kurulum tamam"

# YÃ¼kleme
load: install
	@echo "ğŸš€ Module yÃ¼kleniyor..."
	@if [ $$(id -u) -ne 0 ]; then \
		echo "âŒ Root gerekli: sudo make load"; \
		exit 1; \
	fi
	-rmmod omen_kernel_mainline_final 2>/dev/null
	modprobe omen_kernel_mainline_final
	@echo "âœ… Module yÃ¼klendi"
	@if [ -f /proc/omen_rgb ]; then \
		echo "âœ… /proc/omen_rgb hazÄ±r"; \
	else \
		echo "âš ï¸  /proc/omen_rgb yok - dmesg kontrol et"; \
	fi

# KaldÄ±rma
unload:
	@echo "ğŸ›‘ Module kaldÄ±rÄ±lÄ±yor..."
	@if [ $$(id -u) -ne 0 ]; then \
		echo "âŒ Root gerekli: sudo make unload"; \
		exit 1; \
	fi
	-rmmod omen_kernel_mainline_final
	@echo "âœ… Module kaldÄ±rÄ±ldÄ±"

# Test - gerÃ§ek hardware
hardware_test: load
	@echo "ğŸ”´ Hardware test..."
	@if [ $$(id -u) -ne 0 ]; then \
		echo "âŒ Root gerekli: sudo make hardware_test"; \
		exit 1; \
	fi
	@if [ -f /proc/omen_rgb ]; then \
		echo "green" > /proc/omen_rgb && echo "âœ… YeÅŸil: OK" || echo "âŒ YeÅŸil: FAIL"; \
		sleep 1; \
		echo "red" > /proc/omen_rgb && echo "âœ… KÄ±rmÄ±zÄ±: OK" || echo "âŒ KÄ±rmÄ±zÄ±: FAIL"; \
		sleep 1; \
		echo "blue" > /proc/omen_rgb && echo "âœ… Mavi: OK" || echo "âŒ Mavi: FAIL"; \
		sleep 1; \
		echo "black" > /proc/omen_rgb && echo "âœ… Siyah: OK" || echo "âŒ Siyah: FAIL"; \
	else \
		echo "âŒ /proc/omen_rgb yok"; \
	fi

# Temizlik
clean:
	@echo "ğŸ§¹ Temizlik..."
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
	rm -f *.o *.ko *.mod.c *.mod *.order *.symvers .*.cmd
	rm -rf .tmp_versions/
	@echo "âœ… Temizlik tamam"

# Durum
status:
	@echo "ğŸ“Š Durum:"
	@if [ -f "omen_kernel_mainline_final.ko" ]; then \
		echo "  âœ… Build: OK"; \
	else \
		echo "  âŒ Build: YOK"; \
	fi
	@if lsmod | grep -q "omen_kernel_mainline_final"; then \
		echo "  âœ… Loaded: OK"; \
	else \
		echo "  âŒ Loaded: YOK"; \
	fi
	@if [ -f "/proc/omen_rgb" ]; then \
		echo "  âœ… Interface: OK"; \
	else \
		echo "  âŒ Interface: YOK"; \
	fi

# YardÄ±m
help:
	@echo "ğŸ”§ OMEN RGB Driver - Basit Makefile"
	@echo "=================================="
	@echo ""
	@echo "Komutlar:"
	@echo "  make all           - Build et"
	@echo "  make test          - Basit test"
	@echo "  make install       - Kur (root gerekli)"
	@echo "  make load          - YÃ¼kle (root gerekli)"
	@echo "  make unload        - KaldÄ±r (root gerekli)"
	@echo "  make hardware_test - Hardware test (root gerekli)"
	@echo "  make clean         - Temizle"
	@echo "  make status        - Durum gÃ¶ster"
	@echo "  make help          - Bu yardÄ±m"
	@echo ""
	@echo "HÄ±zlÄ± kullanÄ±m:"
	@echo "  make all && sudo make load"
	@echo "  sudo make hardware_test"
	@echo ""

.PHONY: all test install load unload hardware_test clean status help
